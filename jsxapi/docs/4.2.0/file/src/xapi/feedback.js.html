<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/xapi/feedback.js | jsxapi</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="JavaScript bindings for XAPI"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="jsxapi"><meta property="twitter:description" content="JavaScript bindings for XAPI"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/json-parser.js~JSONParser.html">JSONParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-connect">connect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseJSON">parseJSON</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/stream.html#stream_class_stream_transform">Transform</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#backend">backend</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backend/tsh.js~TSHBackend.html">TSHBackend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backend/ws.js~WSBackend.html">WSBackend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/backend/index.js~Backend.html">Backend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/events.html#events_class_eventemitter">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/stream.html#stream_class_stream_duplex">Duplex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket">WebSocket</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#transport">transport</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/transport/stream.js~StreamTransport.html">StreamTransport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-connectSSH">connectSSH</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-spawnTSH">spawnTSH</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#xapi">xapi</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/xapi/components.js~Config.html">Config</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/xapi/components.js~Event.html">Event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/xapi/components.js~Status.html">Status</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/xapi/exc.js~IllegalValueError.html">IllegalValueError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/xapi/exc.js~InvalidPathError.html">InvalidPathError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/xapi/exc.js~ParameterError.html">ParameterError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/xapi/exc.js~XAPIError.html">XAPIError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/xapi/feedback.js~Feedback.html">Feedback</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/xapi/feedback.js~FeedbackGroup.html">FeedbackGroup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/xapi/index.js~XAPI.html">XAPI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/xapi/components.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/xapi/mixins.js~Gettable.html">Gettable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/xapi/mixins.js~Listenable.html">Listenable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/xapi/mixins.js~Settable.html">Settable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mix">mix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-normalizePath">normalizePath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-collapse">collapse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createCommandResponse">createCommandResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createErrorResponse">createErrorResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createGetResponse">createGetResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createRequest">createRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createResponse">createResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createSetResponse">createSetResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseFeedbackResponse">parseFeedbackResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-COMMAND_ERROR">COMMAND_ERROR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ILLEGAL_VALUE">ILLEGAL_VALUE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-INVALID_PATH">INVALID_PATH</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-INVALID_RESPONSE">INVALID_RESPONSE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-INVALID_STATUS">INVALID_STATUS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-METHOD_NOT_FOUND">METHOD_NOT_FOUND</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PARAMETER_ERROR">PARAMETER_ERROR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UNKNOWN_ERROR">UNKNOWN_ERROR</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/xapi/feedback.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { EventEmitter } from &apos;events&apos;;

import log from &apos;../log&apos;;

import normalizePath from &apos;./normalizePath&apos;;

/**
 * Group feedback deregister handlers for bookkeeping.
 */
export class FeedbackGroup {
  constructor(handlers) {
    this.handlers = handlers;
  }

  /**
   * Add a deregister handler function to the feedback group.
   *
   * @param {function()} handler - Handler to add to the group.
   * @return {FeedbackGroup} - this for chaining.
   */
  add(handler) {
    this.handlers.push(handler);
    return this;
  }

  /**
   * Remove a deregister handler function from the feedback group.
   *
   * @param {function()} handler - Handler to remove from the group.
   * @return {FeedbackGroup} - this for chaining.
   */
  remove(handler) {
    this.handlers = this.handlers.filter(h =&gt; h !== handler);
    return this;
  }

  /**
   * Call the deregister handler functions associated with this group.
   *
   * @return {FeedbackGroup} - this for chaining.
   */
  off() {
    this.handlers.forEach((handler) =&gt; {
      handler();
    });
    this.handlers = [];
    return this;
  }
}

function defaultInterceptor(payload, emit) {
  emit(payload);
}

function dispatch(feedback, data, root = data, path = []) {
  if (Array.isArray(data)) {
    data.forEach((child) =&gt; {
      dispatch(feedback, child, root, path);
      dispatch(feedback, child, root, path.concat(child.id));
    });
    return;
  }

  const emitPath = path.join(&apos;/&apos;).toLowerCase();
  feedback.eventEmitter.emit(emitPath, data, root);

  if (typeof data === &apos;object&apos;) {
    Object.keys(data).forEach((key) =&gt; {
      dispatch(feedback, data[key], root, path.concat(key));
    });
  }
}

/**
 * Feedback handler for the XAPI.
 *
 * @example &lt;caption&gt;Register a feedback listener&lt;/caption&gt;
 * xapi.feedback.on(&apos;Status/Audio/Volume&apos;, data =&gt; {
 *   console.log(`Received feedback data: ${data}`);
 * });
 *
 * @example &lt;caption&gt;Get the feedback root payload&lt;/caption&gt;
 * xapi.feedback.on(&apos;Status/Audio/Volume&apos;, (data, payload) =&gt; {
 *   console.log(`System volume changed to: ${data}`);
 *   JSON.stringify(payload) // =&gt; { Status: { Audio: { Volume: data } } }
 * });
 *
 * @example &lt;caption&gt;Listen to array elements&lt;/caption&gt;
 * xapi.feedback.on(&apos;Status/Call[42]/Status&apos;, callStatus =&gt; {
 *   console.log(`Call status for call number 42 is: ${callStatus}`);
 * });
 *
 * @example &lt;caption&gt;Bundle feedback listeners for easy unsubscription&lt;/caption&gt;
 * const feedbackGroup = xapi.feedback.group([
 *   xapi.status.on(&apos;Audio/Volume&apos;, volumeListener),
 *   xapi.status.on(&apos;Call&apos;, callListener),
 * ]);
 *
 * // Disable feedback listening for all listeners of the group.
 * feedbackGroup.off();
 *
 * @example &lt;caption&gt;Register listener with Array path&lt;/caption&gt;
 * const off = xapi.feedback.on(&apos;Status/Audio/Volume&apos;, listener);
 * off(); // De-register feedback
 */
export default class Feedback {
  /**
   * @param {XAPI} xapi - XAPI instance.
   * @param {function} interceptor - Feedback interceptor.
   */
  constructor(xapi, interceptor = defaultInterceptor) {
    Object.defineProperties(this, {
      eventEmitter: { value: new EventEmitter() },
      interceptor: { value: interceptor },
      xapi: { value: xapi },
      subscriptions: { value: [], writable: true },
    });
  }

  /**
   * Registers a feedback listener with the backend service which is invoked
   * when there is feedback matching the subscription query.
   *
   * @param {Array|string} path - Path to subscribe to
   * @param {function} listener - Listener invoked on feedback
   */
  on(path, listener) {
    log.info(`new feedback listener on: ${path}`);
    const eventPath = normalizePath(path)
      .join(&apos;/&apos;)
      .toLowerCase();

    this.eventEmitter.on(eventPath, listener);

    const registration = this.xapi.execute(&apos;xFeedback/Subscribe&apos;, {
      Query: normalizePath(path),
    });

    const off = () =&gt; {
      registration.then(({ Id }) =&gt; {
        this.xapi.execute(&apos;xFeedback/Unsubscribe&apos;, { Id });
      });

      this.eventEmitter.removeListener(eventPath, listener);
    };

    return off;
  }

  /**
   * Registers a feedback listener similar to {@link on}, but the subscription
   * is removed after the first invocation of the listener.
   *
   * @param {Array|string} path - Path to subscribe to
   * @param {function} listener - Listener invoked on feedback
   */
  once(path, listener) {
    let off;
    const wrapped = (...args) =&gt; {
      if (typeof off === &apos;function&apos;) off();
      listener.call(this, ...args);
    };
    wrapped.listener = listener;
    off = this.on(path, wrapped);
    return off;
  }

  /**
   * Remove feedback registration.
   *
   * @deprecated use deactivation handler from `.on()` and `.once()` instead.
   */
  // eslint-disable-next-line class-methods-use-this
  off() {
    throw new Error(
      &apos;.off() is deprecated. Use return value deactivate handler from .on() instead.&apos;,
    );
  }

  /**
   * Dispatches feedback data to the registered handlers.
   *
   * @param {Object} data - JSON data structure of feedback data.
   * @return {FeedbackHandler} - Returns self for chaining.
   */
  dispatch(data) {
    this.interceptor(data, (d = data) =&gt; dispatch(this, d));
    return this;
  }

  /**
   * Creates a grouper object which tracks which tracks the feedback paths and
   * listeners being added to it.
   *
   * @return {FeedbackGroup} - Proxy object for xapi.feedback
   *
   * @example &lt;caption&gt;Bundle feedback listeners for easy unsubscription&lt;/caption&gt;
   * // Create a group
   * const group = xapi.feedback.group([
   *   xapi.status.on(&apos;Audio Volume&apos;, (volume) =&gt; {
   *     // ...
   *   }),
   *   xapi.config.on(&apos;Audio DefaultVolume&apos;, (volume) =&gt; {
   *     // ...
   *   }),
   * ]);
   *
   * const handler = xapi.status.on(&apos;Call&apos;, (call) =&gt; { ... });
   *
   * // Add handler to the group
   * group.add(handler);
   *
   * // Remove handler from the group
   * group.remove(handler);
   *
   * // Unregister from all feedback handlers
   * group.off();
   */
  // eslint-disable-next-line class-methods-use-this
  group(handlers) {
    return new FeedbackGroup(handlers);
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
